{% extends "_partials/dashboard_teacher/layaout.html" %}
{% load static %}

{% block content %}
    <div class="gradebook-container">
        <div class="content">
            <div id="add-item-form">
                <form method="POST" action="{% url 'create_gradebook' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="class_instance" name="class_instance">
                    <input type="hidden" id="assessment_type" name="assessment_type">

                    <div class="form-group">
                        <label for="class_selector">Select Class:</label>
                        <select id="class_selector" class="form-control" disabled>
                            <option value="">Class will be auto-detected from QR</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="feedback_image">Upload Feedback Image:</label>
                        <input type="file" id="feedback_image" name="feedback_image" accept="image/*" required>
                        <div id="qr-info" class="qr-info"></div>
                    </div>

                    <button type="submit" class="button button-apply">UPLOAD FOR ALL STUDENTS</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <script>
        document.getElementById('feedback_image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const image = new Image();
                image.onload = function() {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = image.width;
                    canvas.height = image.height;
                    context.drawImage(image, 0, 0);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: 'dontInvert',
                    });

                    if (code) {
                        const [classPart, typePart] = code.data.split(',');
                        const classId = classPart.split(':')[1].trim();
                        const assessmentType = typePart.split(':')[1].trim().toUpperCase();

                        document.getElementById('class_instance').value = classId;
                        document.getElementById('assessment_type').value = assessmentType;

                        // Mettre Ã  jour l'affichage
                        document.getElementById('class_selector').value = classId;
                        document.getElementById('qr-info').innerHTML = `
                            <p>Class detected: ${classId}</p>
                            <p>Assessment Type: ${assessmentType}</p>
                        `;
                    } else {
                        alert('No QR code found in the image.');
                    }
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    </script>
{% endblock %}